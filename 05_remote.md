- 第5回はリモート雑談

----

# MySQLで知りたいこと

- MySQL 8系のバージョンアップにどうやって追従してる？
  - 特定のバージョンでフリーズ？
    - 最新版の1個前くらいを使うのが良い
    - でも今の8.0.26はちょっと色々あるので避けた方が良い
      -  トランザクション分離レベルがRCで痛いバグがある
  - 最新版に追従？
    - 上記の通り
  - どんな感じで検証していってる？
    - 開発者任せ
    - テストがあればそこで先にあげる
    - CIがあればそこを先にバージョンあげる
    - ない場合はE2Eテスト
    - E2Eがなければ頑張るしかない…
  - 複数のMySQLがあると8系でも混在しない？
    - 8.0.22くらいから機能が増えてないので最近は差分が少ない
    - 9.0.0は…まだブランチもないしまだ時間はかかりそう
    - 5.7は？CentOS 7が終わるとMySQL5.7の運用も減っていくはず
      - OSのサポートも8だけになっていく
      - Windowsもそう
      - MySQL 8もあと数年だからどうなることやら
      - https://www.mysql.com/jp/support/supportedplatforms/database.html

- HA構成、グループレプリケーション＋MySQL Routerが主流な空気はあるけどやっぱそうなの？
  - MySQL RouterじゃなくてProxySQLとかの例も見るけど
    - MySQL Routerの方がシンプル
    - ProxySQLはpg-poolっぽい
  - グループレプリケーション
    - シングルプライマリーモードで動かせばそれなりにはまともに動くはず
    - 書き込みはスケールしないけど（それはそう）読み込みはスケールする
      - けどリードレプリカは9個までなので、既存で9台以上ぶら下げてたら無理
      - MySQLシェル使うのが良い
  - 内製…っててもある…？大変
    - asyncレプリで内製
      - 大きいところはこれになる？
    - xtradb Cluster or Galera Cluster
      - ペルコナとかMaria使う理由になる
      - マルチマスタの場合の選択肢
  - どちらもリードレプリカが増えれば増えるほど書き込みが遅くなるのでその場合もasyncレプリで頑張る方針になりそう
    - asyncレプリの決定版は無い
  - 書き込みボトルネックはやっぱシャードしましょう
    - まぁRDBMSはこういうもんって感じがする

- 5.7から8に移行のハマりどころってある
  - 新規の採用はあれど、バージョンアップは5.7で様子見してる人が多い印象
    - MySQL 8.0 重いことが多い
    - マシンスペックがしょぼいと遅くなりがち
    - キーワードの非互換でハマりがち
      - RANKとかROLEとか
      - バックスラッシュでくくりましょう
    - GROUP BYのときの暗黙のソートがなくなった
      - それはそう！
      - MySQL、ちょいちょいそういうとこある
    - MySQL 8.0はメモリをよく使う
      - t3.microとかだと死ぬ
        - 4Gくらいだとすぐ無くなる
        - コアも8以上は無いとPerformanceが厳しいと思う
          - 結構リッチな条件になる
          - 仮想とかは注意
          - 20コア　240Gのゲストを払い出し
          - それ以上は物理で払い出し
          - 128
      - MySQL 5.7よりもたくさん使う
      - Performance schemaをoffにするとかinnodb_bufferpoolを控えめにする必要になりそう
  - 実際にAuroraが5.7までってのもあるけど
    - https://hub.docker.com/_/mysql
      - docker公式は5.6までしかない
    - https://hub.docker.com/r/mysql/mysql-server
      - Oracle公式
      - tagが5.5くらいまである
    - https://github.com/mysql/mysql-docker
  - 古いバージョンで生きて行くなら自前Buildになる

  - でもEOL来るので考えて行かなきゃいけないけど、Oracleからベストプラクティスとか方針とかは出てなさそう
  - それは上のバージョンアップの追従方法のベストプラクティスが最新版を使う、しかないところも二の足を踏んでそう
- MySQLを動かすOSの違い
  - Ubuntu VS CentOS
    - 自分はUbuntu派なんだけどCentOSから移行したいって人は多そうな印象
    - Cent 8 Streamな人も結構いるんじゃないかな
      - Cent Linux 8は今年で終わるはず
      - Cent7も2024-6-30で終わる
    - Debianな人とかもいるのかな？
  - RPMで入れてなければ違いも少ないしどっちでも良さそう
    - バイナリ配布
    - ディストリビューションの違いのハマりどころってあります？
  - Windows Serverってどうなの？
    - PostgreSQLは露骨にパフォーマンスが劣化する
    - AzureのPostgreSQLはWindows コンテナなんだよなーって問題が度々出る（MySQLはLinux OSらしいのに！！
    - MySQLも得意じゃない
      - 昔よりはマシになったけど
- 御社クラスのDBだとバックアップどうしてるんですか？
  - RDSならスナップショットあるしいいかーってなるけどオンプレは大変そう
  - xtraBackupをS3に保存するだけでもそこそこ大変
    - ストレージでかくなるじゃん？
    - それはもうそうなる
    - 7日間分とかだとまぁまぁでかくなる
    - 元々ある基盤の仕組みを使うのが良い
      - 仮想なので使い捨て戦略
- MySQL以外のフォークの製品つかってたりしますか？
  - Mariaとかペルコナ、メリットデメリットがもちろんあるけどあんまり聞かない
  - 僕も積極的には勧めてないし、使ってる人がお客さんにいない
    - クラウドのお客さんが多いってのもあるけど
  - MyRocks 使いたいなら選択肢にある
    - Mariaとペルコナは最初からある
    - MySQLで使おうとするとFacebook MySQLのBuildからになる
      - MyRocks は圧縮率が高い
  - ペルコナはMySQL互換なので構文とかの違いが無い
  - MariaDBだとGIDとかレプリのコマンド違いとか困ることある
  - ペルコナは1世代遅れくらいで追従してる
  - ペルコナは使ってる話はちょいちょい聞く
  - ペルコナでHAするならPXCの前段にProxySQL置いて対応するのが推奨構成
- 刺さるクエリの監視について
  - show processlistを監視してる
  - 実行時間を見てる
  - ytkitにもあるよ
    - https://github.com/yoku0825/ytkit/blob/master/lib/Ytkit/HealthCheck.pm#L270-L352
  - 

　

# PostgreSQLで知りたいこと
- よきにどうぞ
  
# その他
- isucon、参加してみてどうでした？
  - 楽しかったので良し
